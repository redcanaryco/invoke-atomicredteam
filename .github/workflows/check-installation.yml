name: Installation Check
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
permissions:
  contents: read
jobs:
  install-check:
    name: Secure Install Check
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout PR branch with history
        uses: actions/checkout@v3
        with:
          fetch-depth: 2 # allow accurate diffs
      - name: Add upstream remote and fetch base branch
        run: |
          git remote add upstream https://github.com/${{ github.repository }}.git
          git fetch upstream main
      - name: Detect fork
        id: forkcheck
        run: |
          if [ "${{ github.repository }}" != "${{ github.event.pull_request.head.repo.full_name }}" ]; then
            echo "is_fork=true" >> $GITHUB_OUTPUT
          else
            echo "is_fork=false" >> $GITHUB_OUTPUT
          fi
      - name: Check if install scripts were modified
        id: filecheck
        run: |
          MODIFIED=$(git diff --name-only upstream/main HEAD)
          echo "$MODIFIED"
          if echo "$MODIFIED" | grep -qE '^install-atomicredteam\.ps1$|^install-atomicsfolder\.ps1$'; then
            echo "scripts_modified=true" >> $GITHUB_OUTPUT
          else
            echo "scripts_modified=false" >> $GITHUB_OUTPUT
          fi
      - name: Decide whether to run scripts
        id: check
        run: |
          if [ "${{ steps.forkcheck.outputs.is_fork }}" = "true" ] && [ "${{ steps.filecheck.outputs.scripts_modified }}" = "true" ]; then
            echo "safe=false" >> $GITHUB_OUTPUT
          else
            echo "safe=true" >> $GITHUB_OUTPUT
          fi
      - name: Execute install scripts
        if: steps.safecheck.outputs.safe == 'true'
        shell: pwsh
        run: |
          Write-Output "Running install scripts from trusted context"
          powershell -ExecutionPolicy Bypass -File ./install-atomicredteam.ps1
          powershell -ExecutionPolicy Bypass -File ./install-atomicsfolder.ps1
      - name: Skip script execution
        if: steps.safecheck.outputs.safe != 'true'
        run: |
          echo "::warning:: install scripts were modified in a forked PR. Skipping execution until merge."
